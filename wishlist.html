<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Julönskelista 2025</title>
  <style>
    :root {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #1f2a37;
      background: #f5f5f5;
    }

    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f9fbff, #f5f5f5);
      min-height: 100vh;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 32px 24px;
      box-shadow: 0 15px 40px rgba(15, 23, 42, 0.08);
    }

    h1 {
      text-align: center;
      color: #b91c1c;
      margin-bottom: 0.5rem;
    }

    p.description {
      text-align: center;
      color: #475569;
      margin-bottom: 2rem;
    }

    form {
      display: grid;
      gap: 1rem;
    }

    label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: block;
      color: #0f172a;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 0.85rem 1rem;
      border: 1px solid #cbd5f5;
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    textarea:focus {
      border-color: #ef4444;
      outline: none;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }

    select {
      background-color: #fff;
      cursor: pointer;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    button {
      background: linear-gradient(135deg, #f97316, #ef4444);
      color: #fff;
      border: none;
      padding: 0.95rem 1.5rem;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.35);
    }

    .error-message {
      color: #b91c1c;
      font-size: 0.9rem;
      min-height: 1.2rem;
    }

    .success-message {
      color: #15803d;
      font-size: 0.9rem;
      min-height: 1.2rem;
    }

    .wishes-section {
      margin-top: 2.5rem;
    }

    .wishes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .wishes-header h2 {
      margin: 0;
      color: #0f172a;
    }

    .wish-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .loading-message {
      text-align: center;
      color: #475569;
    }

    .person-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #fff7f7;
      overflow: hidden;
    }

    .person-card summary {
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      font-weight: 600;
      cursor: pointer;
    }

    .person-card summary::-webkit-details-marker {
      display: none;
    }

    .person-card .count {
      color: #b91c1c;
      font-size: 0.95rem;
    }

    .person-wishes {
      padding: 0 1.25rem 1rem;
      border-top: 1px solid #f1f5f9;
    }

    .person-wishes .empty {
      margin: 1rem 0 0;
      color: #64748b;
      font-style: italic;
    }

    .wish-items {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .wish-items li {
      padding: 1rem;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
    }

    .wish-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 0.35rem;
    }

    .wish-items .item {
      font-size: 1.05rem;
      margin: 0;
      color: #0f172a;
      font-weight: 600;
    }

    .wish-items .meta {
      font-size: 0.9rem;
      color: #475569;
    }

    .wish-items a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
    }

    .wish-items a:hover {
      text-decoration: underline;
    }

    .delete-button {
      background: #fff1f2;
      color: #b91c1c;
      border: 1px solid #fecdd3;
      padding: 0.35rem 0.85rem;
      border-radius: 10px;
      box-shadow: none;
    }

    .delete-button:hover {
      box-shadow: 0 6px 14px rgba(239, 68, 68, 0.2);
    }

    @media (max-width: 640px) {
      .container {
        padding: 24px 18px;
      }

      button {
        width: 100%;
      }

      .delete-button {
        width: auto;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Julönskelista 2025</h1>
    <p class="description">Lägg till ditt namn och vad du önskar dig. Alla med länken kan se och lägga till saker.</p>

    <form id="wishlist-form">
      <div>
        <label for="name">Ditt namn *</label>
        <select id="name" name="name" required>
          <option value="" disabled selected>Välj ditt namn</option>
          <option value="Anders">Anders</option>
          <option value="Cecilia">Cecilia</option>
          <option value="Lena">Lena</option>
          <option value="Linnea">Linnea</option>
          <option value="Linus">Linus</option>
          <option value="Niklas">Niklas</option>
        </select>
      </div>
      <div>
        <label for="item">Önskning *</label>
        <input type="text" id="item" name="item" required />
      </div>
      <div>
        <label for="link">Länk (valfritt)</label>
        <input type="text" id="link" name="link" placeholder="https://..." />
      </div>
      <div>
        <label for="notes">Noteringar (valfritt)</label>
        <textarea id="notes" name="notes"></textarea>
      </div>
      <button type="submit">Lägg till i önskelistan</button>
      <div class="error-message" id="error-message"></div>
      <div class="success-message" id="success-message"></div>
    </form>

    <section class="wishes-section">
      <div class="wishes-header">
        <h2>Önskningar per person</h2>
        <span id="wish-count">0 önskningar</span>
      </div>
      <div class="wish-list" id="wish-list">
        <p class="loading-message">Laddar önskningar...</p>
      </div>
    </section>
  </div>

  <script>
    const PEOPLE = ["Anders", "Cecilia", "Lena", "Linnea", "Linus", "Niklas"];
    const API_URL = "https://script.google.com/macros/s/AKfycbzMxk8IXhPbukZnHTCbUch4jwvOb46tAXjYqYQR7K7A0RGn8PAAtMyODiGFoJAtp0mB/exec";

    const form = document.getElementById("wishlist-form");
    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById("success-message");
    const wishListEl = document.getElementById("wish-list");
    const wishCountEl = document.getElementById("wish-count");

    const formatDate = (isoString) => {
      if (!isoString) return "";
      const date = new Date(isoString);
      return date.toLocaleString("sv-SE");
    };

    const deleteWish = async (wish) => {
      const confirmed = confirm(
        `Ta bort "${wish.item || "(ingen önskning)"}" från ${wish.name}?`
      );

      if (!confirmed) return;

      errorMessage.textContent = "";
      successMessage.textContent = "";

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            action: "delete",
            timestamp: wish.timestamp,
            rowNumber: wish.rowNumber,
          }),
        });
        
        // Check HTTP status first
        if (!response.ok) {
          throw new Error(`HTTP error: ${response.status}`);
        }
        
        // Parse JSON result
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || "Kunde inte ta bort önskningen.");
        }

        successMessage.textContent = "Önskning borttagen.";
        fetchWishes();
      } catch (error) {
        errorMessage.textContent = error.message;
      } finally {
        setTimeout(() => (successMessage.textContent = ""), 4000);
      }
    };

    const renderWishes = (wishes = []) => {
      wishListEl.innerHTML = "";

      const grouped = PEOPLE.map((name) => ({
        name,
        wishes: wishes.filter((wish) => (wish.name || "").trim() === name)
      }));

      grouped.forEach(({ name, wishes: personWishes }) => {
        const details = document.createElement("details");
        details.className = "person-card";

        const summary = document.createElement("summary");
        summary.innerHTML = `
          <span>${name}</span>
          <span class="count">${personWishes.length} ${
            personWishes.length === 1 ? "önskning" : "önskningar"
          }</span>
        `;
        details.appendChild(summary);

        const content = document.createElement("div");
        content.className = "person-wishes";

        if (!personWishes.length) {
          content.innerHTML = '<p class="empty">Inga önskningar än.</p>';
        } else {
          const list = document.createElement("ul");
          list.className = "wish-items";

          personWishes.forEach((wish) => {
            const listItem = document.createElement("li");

            const header = document.createElement("div");
            header.className = "wish-item-header";

            const title = document.createElement("p");
            title.className = "item";
            title.textContent = wish.item || "(ingen önskning)";

            const deleteButton = document.createElement("button");
            deleteButton.type = "button";
            deleteButton.className = "delete-button";
            deleteButton.textContent = "Ta bort";
            deleteButton.addEventListener("click", () => deleteWish(wish));

            header.appendChild(title);
            header.appendChild(deleteButton);
            listItem.appendChild(header);

            if (wish.link) {
              const linkEl = document.createElement("div");
              linkEl.innerHTML = `<strong>Länk:</strong> <a href="${wish.link}" target="_blank" rel="noopener noreferrer">${wish.link}</a>`;
              listItem.appendChild(linkEl);
            }

            if (wish.notes) {
              const notesEl = document.createElement("div");
              notesEl.innerHTML = `<strong>Noteringar:</strong> ${wish.notes}`;
              listItem.appendChild(notesEl);
            }

            const meta = document.createElement("p");
            meta.className = "meta";
            meta.textContent = `Tillagd ${formatDate(wish.timestamp)}`;
            listItem.appendChild(meta);

            list.appendChild(listItem);
          });

          content.appendChild(list);
        }

        details.appendChild(content);
        wishListEl.appendChild(details);
      });

      wishCountEl.textContent = `${wishes.length} ${wishes.length === 1 ? "önskning" : "önskningar"}`;
    };

    const fetchWishes = async () => {
      wishListEl.innerHTML = '<p class="loading-message">Laddar önskningar...</p>';
      try {
        const response = await fetch(API_URL);
        const wishes = await response.json();
        const sorted = wishes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        renderWishes(sorted);
      } catch (error) {
        wishListEl.innerHTML =
          '<p style="color:#b91c1c;">Kunde inte ladda önskningarna just nu. Försök igen senare.</p>';
      }
    };

    const submitWish = async (wishData) => {
      try {
        const response = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(wishData) // important: no Content-Type header to avoid CORS preflight
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || "Kunde inte lägga till önskningen");
        }

        successMessage.textContent = "Önskning tillagd!";
        errorMessage.textContent = "";
        form.reset();
        fetchWishes();
      } catch (error) {
        errorMessage.textContent = error.message;
      } finally {
        setTimeout(() => (successMessage.textContent = ""), 4000);
      }
    };

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      errorMessage.textContent = "";
      successMessage.textContent = "";

      const wishData = {
        name: form.name.value.trim(),
        item: form.item.value.trim(),
        link: form.link.value.trim(),
        notes: form.notes.value.trim()
      };

      if (!wishData.name || !wishData.item) {
        errorMessage.textContent = "Fyll i ditt namn och vad du önskar dig.";
        return;
      }

      submitWish(wishData);
    });

    fetchWishes();
  </script>
</body>
</html>
